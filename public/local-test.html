<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Local Realtime Test</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 640px; margin: 24px auto; }
      button { padding: 10px 16px; margin-right: 8px; }
      #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 8px; height: 200px; overflow:auto; }
    </style>
  </head>
  <body>
    <h1>OpenAI Realtime (WebRTC) — Local Test</h1>
    <p>Click “Call” to talk to your agent without Twilio.</p>
    <p>
      <button id="startBtn">Call</button>
      <button id="hangupBtn" disabled>Hang up</button>
    </p>
    <audio id="remoteAudio" autoplay></audio>
    <h3>Log</h3>
    <div id="log"></div>
    <script>
      const log = (...args) => { const el = document.getElementById('log'); el.textContent += args.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
      let pc, dc, localStream;
      async function startCall() {
        document.getElementById('startBtn').disabled = true;
        document.getElementById('hangupBtn').disabled = false;
        const tokenRes = await fetch('/realtime-session');
        const { client_secret } = await tokenRes.json();
        if (!client_secret) { log('No client_secret'); return; }
        pc = new RTCPeerConnection();
        pc.onconnectionstatechange = () => log('pc state:', pc.connectionState);
        pc.oniceconnectionstatechange = () => log('ice state:', pc.iceConnectionState);
        dc = pc.createDataChannel('oai-events');
        dc.onmessage = (ev) => log('event:', ev.data);
        pc.ontrack = (e) => { document.getElementById('remoteAudio').srcObject = e.streams[0]; };
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getAudioTracks().forEach(t => pc.addTrack(t, localStream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        const resp = await fetch(`https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01&voice=${encodeURIComponent('alloy')}`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${client_secret}`,
            'Content-Type': 'application/sdp',
            'OpenAI-Beta': 'realtime=v1',
          },
          body: offer.sdp,
        });
        const answer = { type: 'answer', sdp: await resp.text() };
        await pc.setRemoteDescription(answer);
        log('Connected. Speak!');
      }
      async function hangup() {
        document.getElementById('hangupBtn').disabled = true;
        try { dc && dc.close(); } catch {}
        try { pc && pc.close(); } catch {}
        try { localStream && localStream.getTracks().forEach(t => t.stop()); } catch {}
        document.getElementById('startBtn').disabled = false;
        log('Call ended.');
      }
      document.getElementById('startBtn').onclick = startCall;
      document.getElementById('hangupBtn').onclick = hangup;
    </script>
  </body>
</html>
